<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Реклама</title>
<script src="pdf.min.js"></script>
<style>
body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: white; /* Белый фон для обрезанных частей */
}
video {
    max-width: 100vw;
    height: 100vh;
    display: none;
    margin: 0 auto; /* Центрирование по горизонтали */
}
canvas#pdfCanvas {
    max-width: 100vw;
    height: 100vh;
    display: none;
    margin: 0 auto; /* Центрирование по горизонтали */
}
#fullscreenBtn {
    position: absolute;
    bottom: 30px;
    right: 20px;
    padding: 10px 20px;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    z-index: 10;
}
#fullscreenBtn:hover {
    background-color: rgba(0, 0, 0, 0.9);
}
#clientInfo {
    position: absolute;
    bottom: 7px;
    right: 20px;
    color: white;
    background-color: rgba(0, 0, 0, 0.7);
    padding: 4px;
    border-radius: 5px;
    z-index: 10;
    font-size: 11px;
    display: none; /* По умолчанию скрыто, пока не загрузится настройка */
}
#marquee {
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    overflow: hidden;
    display: none;
    z-index: 20; /* Выше всех других элементов */
    transform: translateY(-50%);
    padding: 10px 0; /* Отступ для больших шрифтов */
}
#marquee span {
    display: inline-block;
    white-space: nowrap;
    position: absolute;
    left: 100%; /* Начальная позиция за правым краем */
    animation: marquee linear infinite;
}
@keyframes marquee {
    0% { transform: translateX(0); }
    100% { transform: translateX(calc(-100% - 100vw)); } /* Полное скрытие за левым краем */
}
</style>
</head>
<body>
<video id="adVideo" autoplay muted>
    <source src="" type="video/mp4">
</video>
<canvas id="pdfCanvas"></canvas>
<button id="fullscreenBtn">Во весь экран</button>
<div id="clientInfo"></div>
<div id="marquee"><span></span></div>
<script>
// Генерация UUID
function generateUUID() {
    return 'xxxx-4xxxyxxx-xxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
}
// Получение или создания UUID
let uuid = localStorage.getItem('client_uuid');
if (!uuid) {
    uuid = generateUUID();
    localStorage.setItem('client_uuid', uuid);
    fetch('api.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'add_client', uuid })
    }).then(() => loadClientInfo()).catch(err => console.error('Ошибка регистрации клиента:', err));
}
const video = document.getElementById('adVideo');
const pdfCanvas = document.getElementById('pdfCanvas');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const clientInfo = document.getElementById('clientInfo');
const marquee = document.getElementById('marquee');
const marqueeText = marquee.querySelector('span');
let contentList = [];
let currentIndex = 0;
let currentTime = 0;
let pdfTimer = null;
let currentContentUrl = null;
const DEFAULT_PDF_DURATION = 5000;
let messageSettings = { enabled: 0, text: '', color: '#ffffff', font_size: 24, speed: 100, bold: 0, background_color: '#000000' };

// Остановка текущего контента
function stopCurrentContent(force = false) {
    if (!force && contentList.length === 1) {
        return;
    }
    video.pause();
    video.style.display = 'none';
    video.src = ''; // Очищаем источник, чтобы избежать перекрытия
    if (pdfTimer) {
        clearTimeout(pdfTimer);
        pdfTimer = null;
    }
    pdfCanvas.style.display = 'none';
    currentContentUrl = null;
}

// Рендеринг PDF
async function renderPDF(url) {
    try {
        const pdfDoc = await pdfjsLib.getDocument(url).promise;
        const page = await pdfDoc.getPage(1);
        const viewport = page.getViewport({ scale: 1.0 });
        const ctx = pdfCanvas.getContext('2d');
        const scale = window.innerHeight / viewport.height;
        const scaledWidth = viewport.width * scale;
        pdfCanvas.width = scaledWidth;
        pdfCanvas.height = window.innerHeight;
        const scaledViewport = page.getViewport({ scale });
        await page.render({
            canvasContext: ctx,
            viewport: scaledViewport
        }).promise;
        pdfCanvas.style.display = 'block';
    } catch (err) {
        console.error('Ошибка рендеринга PDF:', err);
    }
}

// Показ PDF
async function showPDF(url, duration) {
    if (currentContentUrl === url && contentList.length === 1) {
        if (pdfTimer) clearTimeout(pdfTimer);
        const displayDuration = (duration || 5) * 1000;
        pdfTimer = setTimeout(() => {
            currentIndex = 0;
            showContent(currentIndex);
        }, displayDuration);
        return;
    }
    stopCurrentContent();
    await renderPDF(url);
    currentContentUrl = url;
    const displayDuration = (duration || 5) * 1000;
    pdfTimer = setTimeout(() => {
        currentIndex = (currentIndex + 1) % contentList.length;
        showContent(currentIndex);
    }, displayDuration);
}

// Обработчик окончания видео
video.addEventListener('ended', () => {
    currentIndex = (currentIndex + 1) % contentList.length;
    showContent(currentIndex);
});

// Обработчик загрузки метаданных видео
video.addEventListener('loadedmetadata', () => {
    const videoAspectRatio = video.videoWidth / video.videoHeight;
    const scaledWidth = window.innerHeight * videoAspectRatio;
    video.style.width = `${scaledWidth}px`;
    video.style.height = '100vh';
});

// Загрузка информации об устройстве
async function loadClientInfo() {
    try {
        const response = await fetch(`api.php?action=get_client_info&uuid=${uuid}`, {
            headers: { 'Cache-Control': 'no-cache' }
        });
        const data = await response.json();
        if (data.error) {
            clientInfo.textContent = `UUID: ${uuid.toUpperCase()} | ИМЯ: Неизвестно`;
            clientInfo.style.display = 'none';
            console.error(data.error);
        } else {
            clientInfo.textContent = `UUID: ${uuid.toUpperCase()} | ИМЯ: ${data.name}`;
            clientInfo.style.display = data.show_info === 1 && !messageSettings.enabled ? 'block' : 'none';
        }
    } catch (err) {
        clientInfo.textContent = `UUID: ${uuid.toUpperCase()} | ИМЯ: Ошибка загрузки`;
        clientInfo.style.display = 'none';
        console.error('Ошибка загрузки информации об устройстве:', err);
    }
}

// Загрузка настроек сообщения
async function loadMessageSettings() {
    try {
        const response = await fetch('api.php?action=get_message_settings', {
            headers: { 'Cache-Control': 'no-cache' }
        });
        const newSettings = await response.json();
        console.log('Загружены настройки сообщения:', newSettings); // Отладка
        if (JSON.stringify(newSettings) !== JSON.stringify(messageSettings)) {
            messageSettings = newSettings;
            if (messageSettings.enabled && messageSettings.text) {
                stopCurrentContent(true);
                marquee.style.display = 'block';
                document.body.style.backgroundColor = messageSettings.background_color;
                marqueeText.textContent = messageSettings.text;
                marqueeText.style.color = messageSettings.color;
                marqueeText.style.fontSize = `${messageSettings.font_size}px`;
                marqueeText.style.fontWeight = messageSettings.bold ? 'bold' : 'normal';
                // Устанавливаем высоту контейнера на основе размера шрифта
                marquee.style.height = `${messageSettings.font_size * 1.5}px`; // Учитываем высоту строки
                // Сбрасываем анимацию
                marqueeText.style.animation = 'none';
                marqueeText.offsetHeight; // Принудительный рефлоу
                // Рассчитываем ширину текста и длительность анимации
                const textWidth = marqueeText.offsetWidth || window.innerWidth;
                const containerWidth = window.innerWidth;
                const totalWidth = textWidth + containerWidth;
                const duration = totalWidth / (messageSettings.speed || 100);
                marqueeText.style.animation = `marquee ${duration}s linear infinite`;
                console.log(`Ширина текста: ${textWidth}, Ширина окна: ${containerWidth}, Длительность анимации: ${duration}s`); // Отладка
                clientInfo.style.display = 'none';
                fullscreenBtn.style.display = 'none';
            } else {
                marquee.style.display = 'none';
                marqueeText.style.animation = 'none';
                marqueeText.textContent = '';
                marquee.style.height = '100px'; // Сбрасываем высоту
                document.body.style.backgroundColor = 'white'; // Сбрасываем цвет фона
                showContent(currentIndex, currentTime);
                loadClientInfo();
                if (!document.fullscreenElement) {
                    fullscreenBtn.style.display = 'block';
                }
            }
        }
    } catch (err) {
        console.error('Ошибка загрузки настроек сообщения:', err);
    }
}

// Функция для входа в полноэкранный режим
function enterFullscreen() {
    const element = document.documentElement;
    if (element.requestFullscreen) {
        element.requestFullscreen();
    } else if (element.mozRequestFullScreen) {
        element.mozRequestFullScreen();
    } else if (element.webkitRequestFullscreen) {
        element.webkitRequestFullscreen();
    } else if (element.msRequestFullscreen) {
        element.msRequestFullscreen();
    }
    fullscreenBtn.style.display = 'none';
    clientInfo.style.display = 'none';
}

// Обработчики событий полноэкранного режима
document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
        fullscreenBtn.style.display = messageSettings.enabled ? 'none' : 'block';
        loadClientInfo();
    }
});
document.addEventListener('webkitfullscreenchange', () => {
    if (!document.webkitFullscreenElement) {
        fullscreenBtn.style.display = messageSettings.enabled ? 'none' : 'block';
        loadClientInfo();
    }
});
document.addEventListener('mozfullscreenchange', () => {
    if (!document.mozFullScreenElement) {
        fullscreenBtn.style.display = messageSettings.enabled ? 'none' : 'block';
        loadClientInfo();
    }
});
document.addEventListener('msfullscreenchange', () => {
    if (!document.msFullscreenElement) {
        fullscreenBtn.style.display = messageSettings.enabled ? 'none' : 'block';
        loadClientInfo();
    }
});

fullscreenBtn.addEventListener('click', enterFullscreen);

// Показ контента
async function showContent(index, restoreTime = 0) {
    if (messageSettings.enabled) return; // Не показываем контент, если включено сообщение
    if (index >= contentList.length) {
        index = 0;
    }
    if (contentList.length === 0) {
        stopCurrentContent(true);
        showPDF('/ads.pdf', 5);
        return;
    }
    const item = contentList[index];
    const isSingleItem = contentList.length === 1;
    if (item.type === 'video') {
        if (currentContentUrl === item.file_url && isSingleItem) {
            video.currentTime = 0;
            video.play().catch(err => console.error('Ошибка воспроизведения видео:', err));
            return;
        }
        stopCurrentContent();
        currentIndex = index;
        video.src = item.file_url;
        video.style.display = 'block';
        video.loop = isSingleItem;
        video.currentTime = restoreTime;
        currentContentUrl = item.file_url;
        video.play().catch(err => console.error('Ошибка воспроизведения видео:', err));
    } else if (item.type === 'pdf') {
        currentIndex = index;
        showPDF(item.file_url, item.duration);
    }
}

// Загрузка контента
async function loadContent() {
    try {
        const response = await fetch(`api.php?action=list_client_content&uuid=${uuid}`, {
            headers: { 'Cache-Control': 'no-cache' }
        });
        const newList = await response.json();
        const isEmpty = newList.length === 0;
        const wasEmpty = contentList.length === 0;
        contentList = newList;
        currentIndex = 0;
        currentTime = 0;
        if (contentList.length > 0 && !messageSettings.enabled) {
            showContent(currentIndex);
        } else if (!messageSettings.enabled) {
            stopCurrentContent(true);
            showPDF('/ads.pdf', 5);
        }
        if (wasEmpty !== isEmpty) {
            showContent(currentIndex);
        }
    } catch (err) {
        console.error('Ошибка загрузки контента:', err);
    }
}

// Проверка обновлений
async function checkContent() {
    try {
        const response = await fetch(`api.php?action=list_client_content&uuid=${uuid}`, {
            headers: { 'Cache-Control': 'no-cache' }
        });
        const newList = await response.json();
        if (JSON.stringify(newList) !== JSON.stringify(contentList)) {
            const wasEmpty = contentList.length === 0;
            const isEmpty = newList.length === 0;
            const currentItem = contentList[currentIndex];
            const currentId = currentItem ? `${currentItem.type}_${currentItem.id}` : null;
            contentList = newList;
            currentIndex = 0;
            let restoreTime = 0;
            if (currentItem && newList.some(item => `${item.type}_${item.id}` === currentId)) {
                currentIndex = newList.findIndex(item => `${item.type}_${item.id}` === currentId);
                if (currentIndex === -1) currentIndex = 0;
                restoreTime = currentItem && currentItem.type === 'video' ? video.currentTime : 0;
            }
            if (!messageSettings.enabled) {
                stopCurrentContent(true);
                if (contentList.length > 0) {
                    showContent(currentIndex, restoreTime);
                } else {
                    showPDF('/ads.pdf', 5);
                }
            }
        }
        loadClientInfo();
        loadMessageSettings();
    } catch (err) {
        console.error('Ошибка проверки контента:', err);
    }
}

// Инициализация
loadClientInfo();
loadContent();
loadMessageSettings();
setInterval(checkContent, 1000);
</script>
</body>
</html>
