<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Реклама</title>
<style>
body {
	margin: 0;
	padding: 0;
	overflow: hidden;
}
video {
	width: 100vw;
	height: 100vh;
	object-fit: cover;
	display: none;
}
#fullscreenBtn {
	position: absolute;
	bottom: 30px;
	right: 20px;
	padding: 10px 20px;
	background-color: rgba(0, 0, 0, 0.7);
	color: white;
	border: none;
	border-radius: 5px;
	cursor: pointer;
	z-index: 10;
}
#fullscreenBtn:hover {
	background-color: rgba(0, 0, 0, 0.9);
}
#clientInfo {
	position: absolute;
	bottom: 7px;
	right: 20px;
	color: white;
	background-color: rgba(0, 0, 0, 0.7);
	padding: 4px;
	border-radius: 5px;
	z-index: 10;
	font-size: 11px;
}
</style>
</head>
<body>
<video id="adVideo" autoplay muted>
	<source src="" type="video/mp4">
</video>
<button id="fullscreenBtn">Во весь экран</button>
<div id="clientInfo"></div>
<script>
// Генерация UUID
function generateUUID() {
	return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
		const r = Math.random() * 16 | 0;
		return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
	});
}
// Получение или создание UUID
let uuid = localStorage.getItem('client_uuid');
if (!uuid) {
	uuid = generateUUID();
	localStorage.setItem('client_uuid', uuid);
	fetch('api.php', {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify({ action: 'add_client', uuid })
	}).then(() => loadClientInfo()).catch(err => console.error('Ошибка регистрации клиента:', err));
}
const video = document.getElementById('adVideo');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const clientInfo = document.getElementById('clientInfo');
let contentList = [];
let pendingList = null;
let currentIndex = 0;
let currentTime = 0;
// Обработчик окончания видео для перехода к следующему
video.addEventListener('ended', () => {
	currentIndex = (currentIndex + 1) % contentList.length;  // Цикл: после последнего возвращаемся к 0
	showContent(currentIndex);
});
// Загрузка информации об устройстве
async function loadClientInfo() {
	try {
		const response = await fetch(`api.php?action=get_client_info&uuid=${uuid}`, {
			headers: { 'Cache-Control': 'no-cache' }
		});
		const data = await response.json();
		if (data.error) {
			clientInfo.textContent = `UUID: ${uuid} | Имя: Неизвестно`;
			console.error(data.error);
		} else {
			clientInfo.textContent = `UUID: ${uuid} | Имя: ${data.name}`;
		}
	} catch (err) {
		clientInfo.textContent = `UUID: ${uuid} | Имя: Ошибка загрузки`;
		console.error('Ошибка загрузки информации об устройстве:', err);
	}
}
// Функция для входа в полноэкранный режим
function enterFullscreen() {
	if (video.requestFullscreen) {
		video.requestFullscreen();
	} else if (video.mozRequestFullScreen) { // Firefox
		video.mozRequestFullScreen();
	} else if (video.webkitRequestFullscreen) { // Chrome, Safari, Opera
		video.webkitRequestFullscreen();
	} else if (video.msRequestFullscreen) { // IE/Edge
		video.msRequestFullscreen();
	}
	fullscreenBtn.style.display = 'none'; // Скрываем кнопку
}
// Обработчик события для кнопки
fullscreenBtn.addEventListener('click', enterFullscreen);
// Показываем кнопку при выходе из полноэкранного режима
document.addEventListener('fullscreenchange', () => {
	if (!document.fullscreenElement) {
		fullscreenBtn.style.display = 'block';
	}
});
document.addEventListener('webkitfullscreenchange', () => {
	if (!document.webkitFullscreenElement) {
		fullscreenBtn.style.display = 'block';
	}
});
document.addEventListener('mozfullscreenchange', () => {
	if (!document.mozFullScreenElement) {
		fullscreenBtn.style.display = 'block';
	}
});
document.addEventListener('msfullscreenchange', () => {
	if (!document.msFullscreenElement) {
		fullscreenBtn.style.display = 'block';
	}
});
// Показ видео
function showContent(index, restoreTime = 0) {
	// Нормализуем индекс для цикла (если передан index >= length, сбрасываем на 0)
	if (index >= contentList.length) {
		index = 0;
	}
	if (contentList.length === 0) {
		video.style.display = 'none';
		return;
	}
	const item = contentList[index];
	video.src = item.video_url;
	video.style.display = 'block';
	video.loop = contentList.length === 1;  // Луп только для одного видео
	currentIndex = index;  // Обновляем глобальный индекс
	video.currentTime = restoreTime;
	video.play().catch(err => console.error('Ошибка воспроизведения видео:', err));
}
// Загрузка контента
async function loadContent() {
	try {
		const response = await fetch(`api.php?action=list_client_content&uuid=${uuid}`, {
			headers: { 'Cache-Control': 'no-cache' }
		});
		contentList = await response.json();
		currentIndex = 0;
		currentTime = 0;
		if (contentList.length > 0) {
			showContent(currentIndex);
		} else {
			video.style.display = 'none';
		}
	} catch (err) {
		console.error('Ошибка загрузки контента:', err);
	}
}
// Проверка обновлений
async function checkContent() {
	try {
		const response = await fetch(`api.php?action=list_client_content&uuid=${uuid}`, {
			headers: { 'Cache-Control': 'no-cache' }
		});
		const newList = await response.json();
		if (JSON.stringify(newList) !== JSON.stringify(contentList)) {
			const currentItem = contentList[currentIndex];
			const currentId = currentItem ? `${currentItem.type}_${currentItem.id}` : null;
			let restoreTime = currentItem ? video.currentTime : 0;
			contentList = newList;
			currentIndex = 0;  // Сброс на начало нового списка
			if (currentItem && newList.some(item => `${item.type}_${item.id}` === currentId)) {
				currentIndex = newList.findIndex(item => `${item.type}_${item.id}` === currentId);
				if (currentIndex === -1) currentIndex = 0;
			} else {
				restoreTime = 0;
			}
			showContent(currentIndex, restoreTime);
		}
		loadClientInfo(); // Обновляем информацию об устройстве
	} catch (err) {
		console.error('Ошибка проверки контента:', err);
	}
}
// Инициализация
loadClientInfo();
loadContent();
setInterval(checkContent, 5000);
</script>
</body>
</html>