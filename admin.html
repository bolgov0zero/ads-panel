<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<title>Ads Panel</title>
	<link href="tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-6">
	<div class="max-w-4xl mx-auto">
		<div class="flex items-center justify-center mb-6">
			<img src="/logo.png" alt="Logo" class="w-[30px] h-[30px] mr-2">
			<h2 class="text-3xl font-bold">Управление рекламой</h2>
		</div>

		<!-- Вкладки -->
		<div class="mb-8">
			<div class="flex border-b border-gray-700 space-x-2">
				<button class="tab-button px-3 py-1 text-base font-medium bg-gray-800 hover:bg-gray-700 rounded-t-lg" onclick="openTab('fileTab')">Файлы</button>
				<button class="tab-button px-3 py-1 text-base font-medium bg-gray-800 hover:bg-gray-700 rounded-t-lg" onclick="openTab('clientTab')">Устройства</button>
				<button class="tab-button px-3 py-1 text-base font-medium bg-gray-800 hover:bg-gray-700 rounded-t-lg" onclick="openTab('playlistTab')">Плейлисты</button>
			</div>
		</div>

		<!-- Уведомление -->
		<div id="notification" class="hidden fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg">
			<span id="notificationMessage">Файл успешно загружен!</span>
		</div>

		<!-- Вкладка Файлы -->
		<div id="fileTab" class="tab-content">
			<div class="mb-8">
				<h3 class="text-xl font-semibold mb-4">Загрузка</h3>
				<form id="uploadForm" enctype="multipart/form-data" class="bg-gray-800 p-4 rounded-lg shadow">
					<label class="block mb-2">Файл (MP4 или PDF):</label>
					<input type="file" name="file" accept="video/mp4,application/pdf" required class="mb-4 p-2 bg-gray-700 border border-gray-600 rounded w-full">
					<button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Загрузить</button>
				</form>
			</div>

			<div class="mb-8">
				<h3 class="text-xl font-semibold mb-4">Список файлов</h3>
				<div class="overflow-x-auto">
					<table class="w-full bg-gray-800 rounded-lg shadow">
						<thead>
							<tr class="bg-gray-700">
								<th class="p-3 text-left">ID</th>
								<th class="p-3 text-left">Имя файла</th>
								<th class="p-3 text-left">Тип</th>
								<th class="p-3 text-left">Действия</th>
							</tr>
						</thead>
						<tbody id="fileTable"></tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Вкладка Устройства -->
		<div id="clientTab" class="tab-content hidden">
			<div class="mb-8">
				<h3 class="text-xl font-semibold mb-4">Управление устройствами</h3>
				<div class="overflow-x-auto">
					<table class="w-full bg-gray-800 rounded-lg shadow">
						<thead>
							<tr class="bg-gray-700">
								<th class="p-3 text-left">UUID</th>
								<th class="p-3 text-left">Имя устройства</th>
								<th class="p-3 text-left">Показывать UUID/Имя</th>
								<th class="p-3 text-left">Действия</th>
							</tr>
						</thead>
						<tbody id="clientTable"></tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Вкладка Плейлисты -->
		<div id="playlistTab" class="tab-content hidden">
			<div class="mb-8">
				<h3 class="text-xl font-semibold mb-4">Плейлисты</h3>
				<div class="mb-4">
					<label class="block mb-2">Выберите устройство:</label>
					<select id="clientSelect" class="p-2 bg-gray-700 border border-gray-600 rounded w-full" onchange="loadPlaylist()">
						<option value="">-- Выберите устройство --</option>
					</select>
				</div>
				<div class="overflow-x-auto">
					<table class="w-full bg-gray-800 rounded-lg shadow">
						<thead>
							<tr class="bg-gray-700">
								<th class="p-3 text-left">ID</th>
								<th class="p-3 text-left">Имя файла</th>
								<th class="p-3 text-left">Тип</th>
								<th class="p-3 text-left">Использовать</th>
								<th class="p-3 text-left">Очередность</th>
								<th class="p-3 text-left">Продолжительность (PDF)</th>
							</tr>
						</thead>
						<tbody id="playlistTable"></tbody>
					</table>
				</div>
			</div>
		</div>
		
		<!-- Футер -->
		<footer class="fixed bottom-0 left-0 w-full bg-gray-800 text-gray-400 text-center py-2">
			2025 © Болгов Иван
		</footer>

		<script>
			// Управление вкладками
			function openTab(tabId) {
				document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
				document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('bg-gray-600'));
				document.getElementById(tabId).classList.remove('hidden');
				event.currentTarget.classList.add('bg-gray-600');
			}

			// Показ уведомления
			function showNotification(message) {
				const notification = document.getElementById('notification');
				const messageElement = document.getElementById('notificationMessage');
				messageElement.textContent = message;
				notification.classList.remove('hidden');
				setTimeout(() => {
					notification.classList.add('hidden');
				}, 3000);
			}

			// Обновление всех данных
			function refreshAll() {
				loadFiles();
				loadClients();
				loadPlaylist();
			}

			// Загрузка списка файлов
			async function loadFiles() {
				try {
					const response = await fetch('api.php?action=list_files');
					const files = await response.json();
					const tbody = document.querySelector('#fileTable');
					tbody.innerHTML = '';
					files.forEach(file => {
						const row = document.createElement('tr');
						row.className = 'border-t border-gray-700';
						row.innerHTML = `
							<td class="p-3">${file.id}</td>
							<td class="p-3">
								<input type="text" value="${file.name}" 
									class="p-1 bg-gray-700 border border-gray-600 rounded w-full" 
									onchange="updateFileName(${file.id}, this.value)">
							</td>
							<td class="p-3">${file.type === 'video' ? 'Видео' : 'PDF'}</td>
							<td class="p-3">
								<button onclick="deleteFile(${file.id})" 
									class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">
									Удалить
								</button>
							</td>
						`;
						tbody.appendChild(row);
					});
				} catch (err) {
					console.error('Ошибка загрузки файлов:', err);
				}
			}

			// Загрузка устройств
			async function loadClients() {
				try {
					const response = await fetch('api.php?action=list_clients');
					const clients = await response.json();
					const tbody = document.querySelector('#clientTable');
					const select = document.querySelector('#clientSelect');
					const currentUuid = select.value;
					tbody.innerHTML = '';
					select.innerHTML = '<option value="">-- Выберите устройство --</option>';
					clients.forEach(client => {
						const row = document.createElement('tr');
						row.className = 'border-t border-gray-700';
						row.innerHTML = `
							<td class="p-3" style="text-transform: uppercase;">${client.uuid}</td>
							<td class="p-3">
								<input type="text" value="${client.name}" 
									class="p-1 bg-gray-700 border border-gray-600 rounded w-full" 
									onchange="updateClientName('${client.uuid}', this.value)">
							</td>
							<td class="p-3">
								<input type="checkbox" class="form-checkbox text-blue-600" 
									${client.show_info === 1 ? 'checked' : ''} 
									onchange="updateClientShowInfo('${client.uuid}', this.checked)">
							</td>
							<td class="p-3">
								<button onclick="deleteClient('${client.uuid}')" 
									class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Удалить</button>
							</td>
						`;
						tbody.appendChild(row);
						const option = document.createElement('option');
						option.value = client.uuid;
						option.textContent = client.name;
						if (client.uuid === currentUuid) {
							option.selected = true;
						}
						select.appendChild(option);
					});
				} catch (err) {
					console.error('Ошибка загрузки устройств:', err);
				}
			}

			// Загрузка плейлиста
			async function loadPlaylist() {
				const uuid = document.querySelector('#clientSelect').value;
				if (!uuid) {
					document.querySelector('#playlistTable').innerHTML = '';
					return;
				}
				try {
					const filesResponse = await fetch('api.php?action=list_files');
					const files = await filesResponse.json();
					const contentResponse = await fetch(`api.php?action=list_client_content&uuid=${uuid}`);
					const content = await contentResponse.json();
					const tbody = document.querySelector('#playlistTable');
					tbody.innerHTML = '';
					files.forEach(file => {
						const isUsed = content.some(c => c.id === file.id && c.type === file.type);
						const row = document.createElement('tr');
						row.className = 'border-t border-gray-700';
						row.innerHTML = `
							<td class="p-3">${file.id}</td>
							<td class="p-3">${file.name}</td>
							<td class="p-3">${file.type === 'video' ? 'Видео' : 'PDF'}</td>
							<td class="p-3">
								<input type="checkbox" class="form-checkbox text-blue-600" 
									${isUsed ? 'checked' : ''} 
									onchange="updateClientContent('${uuid}', ${file.id}, '${file.type}', this.checked)">
							</td>
							<td class="p-3">
								<input type="number" value="${file.order_num}" 
									class="w-20 p-1 bg-gray-700 border border-gray-600 rounded" 
									onchange="updateOrder('file', ${file.id}, this.value)">
							</td>
							<td class="p-3">
								${file.type === 'pdf' ? 
									`<input type="number" value="${file.duration || ''}" 
										class="w-20 p-1 bg-gray-700 border border-gray-600 rounded" 
										onchange="updateFileDuration(${file.id}, this.value)" 
										placeholder="5" min="1">` 
									: '-'}
							</td>
						`;
						tbody.appendChild(row);
					});
				} catch (err) {
					console.error('Ошибка загрузки плейлиста:', err);
				}
			}

			// Проверка новых устройств
			let clientCount = 0;
			async function checkNewClients() {
				try {
					const response = await fetch('api.php?action=count_clients');
					const result = await response.json();
					if (result.count !== clientCount) {
						clientCount = result.count;
						refreshAll();
					}
				} catch (err) {
					console.error('Ошибка проверки новых устройств:', err);
				}
			}

			// Запуск периодической проверки
			function startClientCheck() {
				checkNewClients();
				setInterval(checkNewClients, 5000); // Проверка каждые 5 секунд
			}

			// Загрузка файла
			document.getElementById('uploadForm').addEventListener('submit', async (e) => {
				e.preventDefault();
				const formData = new FormData(e.target);
				formData.append('action', 'upload_file');
				try {
					const response = await fetch('api.php', { method: 'POST', body: formData });
					const result = await response.json();
					if (result.error) {
						console.error(result.error);
					} else {
						showNotification('Файл успешно загружен!');
						refreshAll();
					}
				} catch (err) {
					console.error('Ошибка загрузки:', err);
				}
			});

			// Обновление имени файла
			async function updateFileName(id, name) {
				try {
					const response = await fetch('api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'update_file_name', id, name })
					});
					const result = await response.json();
					if (result.error) {
						console.error(result.error);
					}
					refreshAll();
				} catch (err) {
					console.error('Ошибка:', err);
				}
			}

			// Обновление продолжительности PDF
			async function updateFileDuration(id, duration) {
				try {
					const response = await fetch('api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'update_file_duration', id, duration: parseInt(duration) || null })
					});
					const result = await response.json();
					if (result.error) {
						console.error(result.error);
					}
					refreshAll();
				} catch (err) {
					console.error('Ошибка:', err);
				}
			}

			// Обновление порядка
			async function updateOrder(type, id, order) {
				try {
					const response = await fetch('api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: `update_${type}_order`, id, order })
					});
					const result = await response.json();
					if (result.error) {
						console.error(result.error);
					}
					refreshAll();
				} catch (err) {
					console.error('Ошибка:', err);
				}
			}

			// Удаление файла
			async function deleteFile(id) {
				if (confirm('Удалить файл?')) {
					try {
						const response = await fetch('api.php', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ action: 'delete_file', id })
						});
						const result = await response.json();
						if (result.error) {
							console.error(result.error);
						}
						refreshAll();
					} catch (err) {
						console.error('Ошибка:', err);
					}
				}
			}

			// Удаление устройства
			async function deleteClient(uuid) {
				if (confirm('Удалить устройство?')) {
					try {
						const response = await fetch('api.php', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ action: 'delete_client', uuid })
						});
						const result = await response.json();
						if (result.error) {
							console.error(result.error);
						}
						refreshAll();
					} catch (err) {
						console.error('Ошибка:', err);
					}
				}
			}

			// Обновление имени устройства
			async function updateClientName(uuid, name) {
				try {
					const response = await fetch('api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'update_client_name', uuid, name })
					});
					const result = await response.json();
					if (result.error) {
						console.error(result.error);
					}
					refreshAll();
				} catch (err) {
					console.error('Ошибка:', err);
				}
			}

			// Обновление настройки отображения для клиента
			async function updateClientShowInfo(uuid, show_info) {
				try {
					const response = await fetch('api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'update_client_show_info', uuid, show_info: show_info ? 1 : 0 })
					});
					const result = await response.json();
					if (result.error) {
						console.error(result.error);
					} else {
						showNotification('Настройка отображения обновлена');
					}
					refreshAll();
				} catch (err) {
					console.error('Ошибка:', err);
				}
			}

			// Обновление контента устройства
			async function updateClientContent(uuid, content_id, content_type, enabled) {
				try {
					const response = await fetch('api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'update_client_content', uuid, content_id, content_type, enabled })
					});
					const result = await response.json();
					if (result.error) {
						console.error(result.error);
					}
					refreshAll();
				} catch (err) {
					console.error('Ошибка:', err);
				}
			}

			// Инициализация
			refreshAll();
			startClientCheck();
			openTab('fileTab');
		</script>
	</div>
</body>
</html>
