<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<title>Админ-панель</title>
	<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-6">
	<div class="max-w-4xl mx-auto">
		<h2 class="text-3xl font-bold mb-6 text-center">Управление рекламой</h2>

		<!-- Вкладки -->
		<div class="mb-8">
			<div class="flex border-b border-gray-700 space-x-2">
				<button class="tab-button px-3 py-1 text-base font-medium bg-gray-800 hover:bg-gray-700 rounded-t-lg" onclick="openTab('videoTab')">Видео</button>
				<button class="tab-button px-3 py-1 text-base font-medium bg-gray-800 hover:bg-gray-700 rounded-t-lg" onclick="openTab('clientTab')">Устройства</button>
				<button class="tab-button px-3 py-1 text-base font-medium bg-gray-800 hover:bg-gray-700 rounded-t-lg" onclick="openTab('playlistTab')">Плейлисты</button>
			</div>
		</div>

		<!-- Уведомление -->
		<div id="notification" class="hidden fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg">
			<span id="notificationMessage">Видео успешно загружено!</span>
		</div>

		<!-- Вкладка Видео -->
		<div id="videoTab" class="tab-content">
			<div class="mb-8">
				<h3 class="text-xl font-semibold mb-4">Загрузка</h3>
				<form id="uploadForm" enctype="multipart/form-data" class="bg-gray-800 p-4 rounded-lg shadow">
					<label class="block mb-2">Видео (MP4):</label>
					<input type="file" name="video" accept="video/mp4" required class="mb-4 p-2 bg-gray-700 border border-gray-600 rounded w-full">
					<button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Загрузить</button>
				</form>
			</div>

			<div class="mb-8">
				<h3 class="text-xl font-semibold mb-4">Список видео</h3>
				<div class="overflow-x-auto">
					<table class="w-full bg-gray-800 rounded-lg shadow">
						<thead>
							<tr class="bg-gray-700">
								<th class="p-3 text-left">ID</th>
								<th class="p-3 text-left">Имя файла</th>
								<th class="p-3 text-left">Действия</th>
							</tr>
						</thead>
						<tbody id="videoTable"></tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Вкладка Устройства -->
		<div id="clientTab" class="tab-content hidden">
			<div class="mb-8">
				<h3 class="text-xl font-semibold mb-4">Управление устройствами</h3>
				<div class="overflow-x-auto">
					<table class="w-full bg-gray-800 rounded-lg shadow">
						<thead>
							<tr class="bg-gray-700">
								<th class="p-3 text-left">UUID</th>
								<th class="p-3 text-left">Имя устройства</th>
								<th class="p-3 text-left">Действия</th>
							</tr>
						</thead>
						<tbody id="clientTable"></tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Вкладка Плейлисты -->
		<div id="playlistTab" class="tab-content hidden">
			<div class="mb-8">
				<h3 class="text-xl font-semibold mb-4">Плейлисты</h3>
				<div class="mb-4">
					<label class="block mb-2">Выберите устройство:</label>
					<select id="clientSelect" class="p-2 bg-gray-700 border border-gray-600 rounded w-full" onchange="loadPlaylist()">
						<option value="">-- Выберите устройство --</option>
					</select>
				</div>
				<div class="overflow-x-auto">
					<table class="w-full bg-gray-800 rounded-lg shadow">
						<thead>
							<tr class="bg-gray-700">
								<th class="p-3 text-left">ID</th>
								<th class="p-3 text-left">Имя файла</th>
								<th class="p-3 text-left">Использовать</th>
								<th class="p-3 text-left">Очередность</th>
							</tr>
						</thead>
						<tbody id="playlistTable"></tbody>
					</table>
				</div>
			</div>
		</div>

		<script>
			// Управление вкладками
			function openTab(tabId) {
				document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
				document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('bg-gray-600'));
				document.getElementById(tabId).classList.remove('hidden');
				event.currentTarget.classList.add('bg-gray-600');
			}

			// Показ уведомления
			function showNotification(message) {
				const notification = document.getElementById('notification');
				const messageElement = document.getElementById('notificationMessage');
				messageElement.textContent = message;
				notification.classList.remove('hidden');
				setTimeout(() => {
					notification.classList.add('hidden');
				}, 3000);
			}

			// Обновление всех данных
			function refreshAll() {
				loadVideos();
				loadClients();
				loadPlaylist();
			}

			// Загрузка списка видео
			async function loadVideos() {
				try {
					const response = await fetch('api.php?action=list_videos');
					const videos = await response.json();
					const tbody = document.querySelector('#videoTable');
					tbody.innerHTML = '';
					videos.forEach(video => {
						const row = document.createElement('tr');
						row.className = 'border-b border-gray-700';
						row.innerHTML = `
							<td class="p-3">${video.id}</td>
							<td class="p-3">
								<input type="text" value="${video.name}" 
									class="p-1 bg-gray-700 border border-gray-600 rounded w-full" 
									onchange="updateVideoName(${video.id}, this.value)">
							</td>
							<td class="p-3">
								<button onclick="deleteVideo(${video.id})" 
									class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Удалить</button>
							</td>
						`;
						tbody.appendChild(row);
					});
				} catch (err) {
					console.error('Ошибка загрузки видео:', err);
				}
			}

			// Загрузка устройств
			async function loadClients() {
				try {
					const response = await fetch('api.php?action=list_clients');
					const clients = await response.json();
					const tbody = document.querySelector('#clientTable');
					const select = document.querySelector('#clientSelect');
					const currentUuid = select.value;
					tbody.innerHTML = '';
					select.innerHTML = '<option value="">-- Выберите устройство --</option>';
					clients.forEach(client => {
						const row = document.createElement('tr');
						row.className = 'border-b border-gray-700';
						row.innerHTML = `
							<td class="p-3">${client.uuid}</td>
							<td class="p-3">
								<input type="text" value="${client.name}" 
									class="p-1 bg-gray-700 border border-gray-600 rounded w-full" 
									onchange="updateClientName('${client.uuid}', this.value)">
							</td>
							<td class="p-3">
								<button onclick="deleteClient('${client.uuid}')" 
									class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Удалить</button>
							</td>
						`;
						tbody.appendChild(row);
						const option = document.createElement('option');
						option.value = client.uuid;
						option.textContent = client.name;
						if (client.uuid === currentUuid) {
							option.selected = true;
						}
						select.appendChild(option);
					});
				} catch (err) {
					console.error('Ошибка загрузки устройств:', err);
				}
			}

			// Загрузка плейлиста
			async function loadPlaylist() {
				const uuid = document.querySelector('#clientSelect').value;
				if (!uuid) {
					document.querySelector('#playlistTable').innerHTML = '';
					return;
				}
				try {
					const videosResponse = await fetch('api.php?action=list_videos');
					const videos = await videosResponse.json();
					const contentResponse = await fetch(`api.php?action=list_client_content&uuid=${uuid}`);
					const content = await contentResponse.json();
					const tbody = document.querySelector('#playlistTable');
					tbody.innerHTML = '';
					videos.forEach(video => {
						const isUsed = content.some(c => c.id === video.id && c.type === 'video');
						const row = document.createElement('tr');
						row.className = 'border-b border-gray-700';
						row.innerHTML = `
							<td class="p-3">${video.id}</td>
							<td class="p-3">${video.name}</td>
							<td class="p-3">
								<input type="checkbox" class="form-checkbox text-blue-600" 
									${isUsed ? 'checked' : ''} 
									onchange="updateClientContent('${uuid}', ${video.id}, 'video', this.checked)">
							</td>
							<td class="p-3">
								<input type="number" value="${video.order_num}" 
									class="w-20 p-1 bg-gray-700 border border-gray-600 rounded" 
									onchange="updateOrder('video', ${video.id}, this.value)">
							</td>
						`;
						tbody.appendChild(row);
					});
				} catch (err) {
					console.error('Ошибка загрузки плейлиста:', err);
				}
			}

			// Проверка новых устройств
			let clientCount = 0;
			async function checkNewClients() {
				try {
					const response = await fetch('api.php?action=count_clients');
					const result = await response.json();
					if (result.count !== clientCount) {
						clientCount = result.count;
						refreshAll();
					}
				} catch (err) {
					console.error('Ошибка проверки новых устройств:', err);
				}
			}

			// Запуск периодической проверки
			function startClientCheck() {
				checkNewClients();
				setInterval(checkNewClients, 5000); // Проверка каждые 5 секунд
			}

			// Загрузка видео
			document.getElementById('uploadForm').addEventListener('submit', async (e) => {
				e.preventDefault();
				const formData = new FormData(e.target);
				formData.append('action', 'upload_video');
				try {
					const response = await fetch('api.php', { method: 'POST', body: formData });
					const result = await response.json();
					if (result.error) {
						console.error(result.error);
					} else {
						showNotification('Видео успешно загружено!');
						refreshAll();
					}
				} catch (err) {
					console.error('Ошибка загрузки:', err);
				}
			});

			// Обновление имени видео
			async function updateVideoName(id, name) {
				try {
					const response = await fetch('api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'update_video_name', id, name })
					});
					const result = await response.json();
					if (result.error) {
						console.error(result.error);
					}
					refreshAll();
				} catch (err) {
					console.error('Ошибка:', err);
				}
			}

			// Обновление порядка
			async function updateOrder(type, id, order) {
				try {
					const response = await fetch('api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: `update_${type}_order`, id, order })
					});
					const result = await response.json();
					if (result.error) {
						console.error(result.error);
					}
					refreshAll();
				} catch (err) {
					console.error('Ошибка:', err);
				}
			}

			// Удаление видео
			async function deleteVideo(id) {
				if (confirm('Удалить видео?')) {
					try {
						const response = await fetch('api.php', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ action: 'delete_video', id })
						});
						const result = await response.json();
						if (result.error) {
							console.error(result.error);
						}
						refreshAll();
					} catch (err) {
						console.error('Ошибка:', err);
					}
				}
			}

			// Удаление устройства
			async function deleteClient(uuid) {
				if (confirm('Удалить устройство?')) {
					try {
						const response = await fetch('api.php', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ action: 'delete_client', uuid })
						});
						const result = await response.json();
						if (result.error) {
							console.error(result.error);
						}
						refreshAll();
					} catch (err) {
						console.error('Ошибка:', err);
					}
				}
			}

			// Обновление имени устройства
			async function updateClientName(uuid, name) {
				try {
					const response = await fetch('api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'update_client_name', uuid, name })
					});
					const result = await response.json();
					if (result.error) {
						console.error(result.error);
					}
					refreshAll();
				} catch (err) {
					console.error('Ошибка:', err);
				}
			}

			// Обновление контента устройства
			async function updateClientContent(uuid, content_id, content_type, enabled) {
				try {
					const response = await fetch('api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'update_client_content', uuid, content_id, content_type, enabled })
					});
					const result = await response.json();
					if (result.error) {
						console.error(result.error);
					}
					refreshAll();
				} catch (err) {
					console.error('Ошибка:', err);
				}
			}

			// Инициализация
			refreshAll();
			startClientCheck();
			openTab('videoTab');
		</script>
	</div>
</body>
</html>